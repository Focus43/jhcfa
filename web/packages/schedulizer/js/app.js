!function(e,t){"use strict";t.module("schedulizer",["ngResource","schedulizer.app","mgcrea.ngStrap.datepicker","mgcrea.ngStrap.timepicker","calendry"]).config(["$provide","$locationProvider",function(t,n){n.html5Mode(!1);var a=e._Schedulizer;t.factory("Routes",function(){var e={api:{calendar:a.api+"/calendar",event:a.api+"/event",eventNullify:a.api+"/event/nullify",eventTag:a.api+"/event/tag",eventList:a.api+"/event/list",timezones:a.api+"/timezones"},dashboard:a.dashboard};return{routeList:e,generate:function(t,n){var a=t.split(".").reduce(function(e,t){return e[t]},e);return(n||[]).length?a+"/"+n.join("/"):a}}})}]).factory("API",["$resource","Routes",function(e,n){function a(){return{update:{method:"PUT",params:{_method:"PUT"}}}}return{calendar:e(n.generate("api.calendar",[":id"]),{id:"@id"},t.extend(a(),{})),event:e(n.generate("api.event",[":id"]),{id:"@id"},t.extend(a(),{})),eventNullify:e(n.generate("api.eventNullify",[":id"]),{id:"@id"},t.extend(a(),{})),eventTag:e(n.generate("api.eventTag",[":id"]),{id:"@id"},t.extend(a(),{})),timezones:e(n.generate("api.timezones"),{},{get:{isArray:!0,cache:!0}}),_routes:n}}]),t.element(document).ready(function(){return e._Schedulizer?(t.bootstrap(document,["schedulizer"]),void 0):(alert("Schedulizer is missing a configuration to run and has aborted."),void 0)})}(window,window.angular),angular.module("schedulizer.app",[]),angular.module("calendry",[]),angular.module("schedulizer.app").factory("Helpers",["_moment",function(){return this.range=function(e,t){for(var n=[],a=e;t>=a;a++)n.push(a);return n},this.repeatTypeHandleOptions=function(){return[{label:"Days",value:"daily"},{label:"Weeks",value:"weekly"},{label:"Months",value:"monthly"},{label:"Years",value:"yearly"}]},this.repeatIndefiniteOptions=function(){return[{label:"Forever",value:!0},{label:"Until",value:!1}]},this.weekdayRepeatOptions=function(){return[{label:"Sun",value:1},{label:"Mon",value:2},{label:"Tue",value:3},{label:"Wed",value:4},{label:"Thu",value:5},{label:"Fri",value:6},{label:"Sat",value:7}]},this.repeatMonthlyMethodOptions=function(){return{specific:"specific",dynamic:"ordinal"}},this.repeatMonthlyDynamicWeekOptions=function(){return[{label:"First",value:1},{label:"Second",value:2},{label:"Third",value:3},{label:"Fourth",value:4},{label:"Last",value:5}]},this.repeatMonthlyDynamicWeekdayOptions=function(){return[{label:"Sunday",value:1},{label:"Monday",value:2},{label:"Tuesday",value:3},{label:"Wednesday",value:4},{label:"Thursday",value:5},{label:"Friday",value:6},{label:"Saturday",value:7}]},this.eventColorOptions=function(){return[{value:"#A3D900"},{value:"#3A87AD"},{value:"#DE4E56"},{value:"#BFBFFF"},{value:"#FFFF73"},{value:"#FFA64D"},{value:"#CCCCCC"},{value:"#00B7FF"},{value:"#222222"}]},this}]),angular.module("schedulizer.app").directive("calendar",["$rootScope","_moment","ModalManager","Routes",function(e,t,n,a){function i(e,t,i){t.fullCalendar({header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},editable:!0,defaultView:"month",events:i.feed,dayClick:function(t){e.$apply(function(){n.data={source:a.generate("views.eventFormModal"),eventObj:{calendarID:+i.id,startUTC:t.local().clone().add(9,"hours"),endUTC:t.local().clone().add(10,"hours"),repeatEndUTC:t.local().clone().add(10,"hours")}}})},eventClick:function(t){e.$apply(function(){n.data={source:a.generate("views.eventFormModal"),eventObj:t}})}})}return{restrict:"A",link:i}}]),angular.module("schedulizer.app").directive("eventTimeForm",[function(){function e(){}return{restrict:"A",templateUrl:"/event_timing_form",scope:{_timeEntity:"=eventTimeForm"},link:e,controller:["$rootScope","$scope","$filter","API","Helpers","_moment",function(e,t,n,a,i,r){function l(){null===t._timeEntity.repeatEvery&&(t._timeEntity.repeatEvery=t.repeatEveryOptions[0]),null===t._timeEntity.repeatIndefinite&&(t._timeEntity.repeatIndefinite=t.repeatIndefiniteOptions[0].value),t._timeEntity.repeatTypeHandle===t.repeatTypeHandleOptions[2].value&&(null===t._timeEntity.repeatMonthlyMethod&&(t._timeEntity.repeatMonthlyMethod=t.repeatMonthlyMethodOptions.specific),null===t._timeEntity.repeatMonthlySpecificDay&&(t._timeEntity.repeatMonthlySpecificDay=t.repeatMonthlySpecificDayOptions[0]),null===t._timeEntity.repeatMonthlyOrdinalWeek&&(t._timeEntity.repeatMonthlyOrdinalWeek=t.repeatMonthlyDynamicWeekOptions[0].value),null===t._timeEntity.repeatMonthlyOrdinalWeekday&&(t._timeEntity.repeatMonthlyOrdinalWeekday=t.repeatMonthlyDynamicWeekdayOptions[0].value))}function o(){t._timeEntity.repeatMonthlyMethod=null,t._timeEntity.repeatMonthlyOrdinalWeek=null,t._timeEntity.repeatMonthlyOrdinalWeekday=null,t._timeEntity.repeatMonthlySpecificDay=null}function c(){t._timeEntity.weeklyDays=[],angular.forEach(t.weekdayRepeatOptions,function(e){e.checked=!1})}function u(){o(),c(),t._timeEntity.repeatEndUTC=null,t._timeEntity.repeatEvery=null,t._timeEntity.repeatIndefinite=null,t._timeEntity.repeatTypeHandle=null}t.repeatTypeHandleOptions=i.repeatTypeHandleOptions(),t.repeatIndefiniteOptions=i.repeatIndefiniteOptions(),t.weekdayRepeatOptions=i.weekdayRepeatOptions(),t.repeatMonthlyMethodOptions=i.repeatMonthlyMethodOptions(),t.repeatMonthlySpecificDayOptions=i.range(1,31),t.repeatMonthlyDynamicWeekdayOptions=i.repeatMonthlyDynamicWeekdayOptions(),t.repeatMonthlyDynamicWeekOptions=i.repeatMonthlyDynamicWeekOptions(),t.selectedWeekdays=function(){var e=n("filter")(t.weekdayRepeatOptions,{checked:!0});t._timeEntity.weeklyDays=e.map(function(e){return e.value})},angular.isArray(t._timeEntity.weeklyDays)&&t._timeEntity.weeklyDays.length>=1&&angular.forEach(t.weekdayRepeatOptions,function(e){e.checked=t._timeEntity.weeklyDays.indexOf(e.value)>-1}),t.$watch("_timeEntity.repeatTypeHandle",function(e){switch(e){case t.repeatTypeHandleOptions[0].value:t.repeatEveryOptions=i.range(1,31),o(),c();break;case t.repeatTypeHandleOptions[1].value:t.repeatEveryOptions=i.range(1,30),o();break;case t.repeatTypeHandleOptions[2].value:t.repeatEveryOptions=i.range(1,11),c();break;case t.repeatTypeHandleOptions[3].value:t.repeatEveryOptions=i.range(1,5),o(),c()}null!==t._timeEntity.repeatTypeHandle&&l()}),t.$watch("_timeEntity.repeatIndefinite",function(e){e===!0&&(t._timeEntity.repeatEndUTC=null)}),t.$watch("_timeEntity.startUTC",function(e){e&&(t.calendarEndMinDate=r(e).subtract(1,"day"),r(t._timeEntity.endUTC).isBefore(r(t._timeEntity.startUTC))&&(t._timeEntity.endUTC=r(t._timeEntity.startUTC)))}),t.$watch("_timeEntity.isRepeating",function(e){e===!0&&null===t._timeEntity.repeatTypeHandle&&(t._timeEntity.repeatTypeHandle=t.repeatTypeHandleOptions[0].value),e===!1&&u()}),t.showNullifiers=!1,a.eventNullify.query({eventTimeID:t._timeEntity.id},function(e){t.hasNullifiers=e.length>=1,angular.forEach(e,function(e){e._moment=r.utc(e.hideOnDate)}),t.configuredNullifiers=e}),t.cancelNullifier=function(t){t.$delete(function(){e.$emit("calendar.refresh")})}}]}}]),angular.module("schedulizer.app").run([function(){angular.element(document.querySelector("body")).append('<div modal-window class="schedulizer-app" ng-class="manager.classes"><a class="icon-close" modal-close></a><div class="modal-inner" ng-include="manager.data.source"></div></div>')}]).factory("ModalManager",[function(){return{classes:{open:!1},data:{source:null}}}]).directive("modalize",[function(){function e(e,t,n){t.on("click",function(){e.$apply(function(){e.manager.data=angular.extend({source:n.modalize},e.using)})})}return{restrict:"A",scope:{using:"=using"},link:e,controller:["$scope","ModalManager",function(e,t){e.manager=t}]}}]).directive("modalClose",["ModalManager",function(e){function t(t,n){n.on("click",function(){t.$apply(function(){e.classes.open=!1,e.data=null})})}return{restrict:"A",link:t}}]).directive("modalWindow",[function(){function e(e){e.$watch("manager.classes.open",function(t){angular.element(document.documentElement).toggleClass("schedulizer-modal",t),t||(e.manager.data=null)})}return{restrict:"A",scope:!0,link:e,controller:["$scope","ModalManager",function(e,t){e.manager=t,e.$on("$includeContentLoaded",function(){e.manager.classes.open=!0})}]}}]),angular.module("schedulizer.app").directive("redactorized",[function(){function e(e,n,a,i){i.$render=function(){n.val(i.$viewValue),n.redactor(angular.extend(t,{changeCallback:function(){i.$setViewValue(this.get())}})),i.$viewValue&&n.redactor("set",i.$viewValue)}}var t={minHeight:200,concrete5:{filemanager:!0,sitemap:!0,lightbox:!0},plugins:["fontcolor","concrete5","underline"]};return{priority:0,require:"?ngModel",restrict:"A",link:e}}]),angular.module("schedulizer.app").filter("numberContraction",function(){var e=["th","st","nd","rd"];return function(t){var n=20>t?t:t%(10*Math.floor(t/10)),a=3>=n?e[n]:e[0];return a}}),angular.module("schedulizer.app").controller("CtrlCalendar",["$rootScope","$scope","$http","$cacheFactory","API",function(e,t,n,a,i){function r(e){return n.get(i._routes.generate("api.eventList",[t.calendarID]),{cache:l,params:{start:e.calendarStart.format("YYYY-MM-DD"),end:e.calendarEnd.format("YYYY-MM-DD"),fields:o.join(",")}})}var l=a("calendarData"),o=["eventID","eventTimeID","calendarID","title","eventColor","isAllDay","isSynthetic","computedStartUTC","computedStartLocal"];t.instance={parseDateField:"computedStartLocal",onMonthChange:function(e){r(e).then(function(e){t.instance.events=e.data})},onDropEnd:function(e,t){console.log(e,t)}},e.$on("calendar.refresh",function(){l.removeAll(),r(t.instance.monthMap,!0).then(function(e){t.instance.events=e.data})})}]),angular.module("schedulizer.app").controller("CtrlCalendarForm",["$scope","$q","$window","ModalManager","API",function(e,t,n,a,i){e._ready=!1,e._requesting=!1;var r=[i.timezones.get().$promise];a.data.calendarID&&r.push(i.calendar.get({id:a.data.calendarID}).$promise),t.all(r).then(function(t){e.timezoneOptions=t[0],e.entity=t[1]||new i.calendar({defaultTimezone:e.timezoneOptions[e.timezoneOptions.indexOf("America/Denver")]}),e._ready=!0},function(e){console.log(e)}),e.submitHandler=function(){e._requesting=!0,(e.entity.id?e.entity.$update():e.entity.$save()).then(function(t){e._requesting=!1,n.location.href=i._routes.generate("dashboard",["calendars","manage",t.id])})}}]),angular.module("schedulizer.app").controller("CtrlEventForm",["$rootScope","$scope","$q","$filter","Helpers","ModalManager","API","_moment",function(e,t,n,a,i,r,l,o){function c(e){return angular.extend({startUTC:o(),endUTC:o(),isOpenEnded:!1,isAllDay:!1,isRepeating:!1,repeatTypeHandle:null,repeatEvery:null,repeatIndefinite:null,repeatEndUTC:null,repeatMonthlyMethod:null,repeatMonthlySpecificDay:null,repeatMonthlyOrdinalWeek:null,repeatMonthlyOrdinalWeekday:null,weeklyDays:[]},e||{})}t._ready=!1,t._requesting=!1,t.eventColorOptions=i.eventColorOptions(),t.timingTabs=[],t.warnAliased=r.data.eventObj.isSynthetic||!1,t.warnAliased&&(t._ready=!0);var u=[l.timezones.get().$promise,l.calendar.get({id:r.data.eventObj.calendarID}).$promise];n.all(u).then(function(e){t.timezoneOptions=e[0],t.calendarObj=e[1],r.data.eventObj.eventID||(t.entity=new l.event({calendarID:t.calendarObj.id,title:"",description:"",useCalendarTimezone:!0,timezoneName:t.calendarObj.defaultTimezone,eventColor:t.eventColorOptions[0].value,_timeEntities:[c()]}),jQuery('[data-file-selector="fileID"]').concreteFileSelector({inputName:"fileID",filters:[{field:"type",type:1}]}),t._ready=!0)}),r.data.eventObj.eventID&&(u.push(l.event.get({id:r.data.eventObj.eventID}).$promise),n.all(u).then(function(e){e[2]._timeEntities.map(function(e){return c(e)}),t.entity=e[2],jQuery('[data-file-selector="fileID"]').concreteFileSelector({inputName:"fileID",fID:t.entity.fileID,filters:[{field:"type",type:1}]}),t._ready=!0})),t.setTimingTabActive=function(e){angular.forEach(t.timingTabs,function(e){e.active=!1}),t.timingTabs[e].active=!0},t.addTimeEntity=function(){t.entity._timeEntities.push(c())},t.removeTimeEntity=function(e){t.entity._timeEntities.splice(e,1)},t.$watchCollection("entity._timeEntities",function(e){angular.isArray(e)&&(t.timingTabs=i.range(1,e.length).map(function(t,n){return{label:"Time "+t,active:n===e.length-1}}))}),t.$watch("calendarObj",function(e){angular.isObject(e)&&(t.useCalendarTimezoneOptions=[{label:"Use Calendar Timezone ("+t.calendarObj.defaultTimezone+")",value:!0},{label:"Event Uses Custom Timezone",value:!1}])}),t.$watch("entity.useCalendarTimezone",function(e){e===!0&&(t.entity.timezoneName=t.calendarObj.defaultTimezone)}),t.submitHandler=function(){t.entity.fileID=parseInt(jQuery('input[type="hidden"]',".ccm-file-selector").val())||null,t._requesting=!0,(t.entity.id?t.entity.$update():t.entity.$save()).then(function(){t._requesting=!1,e.$emit("calendar.refresh"),r.classes.open=!1})},t.confirmDelete=!1,t.deleteEvent=function(){t.entity.$delete().then(function(t){t.ok&&(e.$emit("calendar.refresh"),r.classes.open=!1)})},t.nullifyInSeries=function(){var t=new l.eventNullify({eventTimeID:r.data.eventObj.eventTimeID,hideOnDate:r.data.eventObj.computedStartUTC});t.$save().then(function(){e.$emit("calendar.refresh"),r.classes.open=!1})}}]),angular.module("schedulizer.app").provider("_moment",function(){this.$get=["$window","$log",function(e,t){return e.moment||(t.warn("MomentJS unavailable!"),!1)}]}),function(e,t){"use strict";t.module("calendry").factory("MomentJS",["$window","$log",function(e,t){return e.moment||(t.warn("Moment.JS not available in global scope, Calendry will be unavailable."),!1)}]).directive("calendry",["$cacheFactory","$document","$log","$q","MomentJS",function(e,n,a,i,r){function l(e){this.monthStart=e,this.monthEnd=r(this.monthStart).endOf("month"),this.calendarStart=r(this.monthStart).subtract(this.monthStart.day(),"day"),this.calendarEnd=r(this.monthEnd).add(6-this.monthEnd.day(),"day"),this.calendarDayCount=Math.abs(this.calendarEnd.diff(this.calendarStart,"days")),this.calendarDays=function(e,t,n){for(var a=0;e>=a;a++)n.push(r(t).add("days",a));return n}(this.calendarDayCount,this.calendarStart,[])}function o(e){var t=r.isMoment(e)?r(e).startOf("month"):r({day:1}),n=t.format(f);return m.get(n)?m.get(n):(m.put(n,new l(t)),m.get(n))}function c(e){return v.dayCellClass+"-"+e.format("YYYY_MM_DD")}function u(e){var t=r(),n=e.monthStart.format("YYYY_MM");if(y.get(n))return y.get(n).cloneNode(!0);for(var a=p.createDocumentFragment(),i=0,l=e.calendarDays.length;l>i;i++){var o=p.createElement("div"),u=e.calendarDays[i].isSame(e.monthStart,"month")?"month-incl":"month-excl",d=e.calendarDays[i].isSame(t,"day")?"is-today":"";o.setAttribute("id",c(e.calendarDays[i])),o.className=v.dayCellClass+" "+u+" "+d,o.innerHTML='<span class="date-num">'+e.calendarDays[i].format("DD")+"<small>"+e.calendarDays[i].format("MMM")+"</small></span>",a.appendChild(o)}return y.put(n,a),y.get(n).cloneNode(!0)}function d(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,n,a){return t+t+n+n+a+a});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:null}function s(e,n,a,i,l){function o(e){var a=t.element(n[0].querySelector(".calendar-render")),i=Math.ceil(e.calendarDayCount/7);t.element(n[0].querySelector(".calendry-body")).removeClass("week-rows-4 week-rows-5 week-rows-6").addClass("week-rows-"+i);var r=u(e);Array.prototype.slice.call(r.childNodes).forEach(function(n,a){r.childNodes[a]=t.element(n).data("_moment",e.calendarDays[a])}),a.empty().append(r)}function d(a){function i(e,t){e.append(t)}t.element(n[0].querySelectorAll(".event-cell")).remove();var o={};a.forEach(function(t){t._moment=r(t[e.instance.parseDateField],r.ISO_8601);var n=t._moment.format(h);o[n]||(o[n]=[]),o[t._moment.format(h)].push(t)}),e.instance.monthMap.calendarDays.forEach(function(a){var r=o[a.format(h)];if(r){var u=t.element(n[0].querySelector("#"+c(a)));if(u)for(var d=0,s=r.length;s>d;d++){var p=e.$new();p.eventObj=r[d],l(p,i.bind(null,u))}}})}e.$watch("instance.monthMap",function(e){e&&o(e)}),e.$watch("events",function(e){t.isArray(e)&&d(e)})}if(!r)return a.warn("Calendry not instantiated due to missing momentJS library"),void 0;var p=n[0],m=e("monthMap"),y=e("docFrags"),f="YYYY_MM",h="YYYY_MM_DD",v={forceListView:!1,daysOfWeek:r.weekdaysShort(),currentMonth:r(),dayCellClass:"day-node",parseDateField:"startDate",onMonthChange:function(){},onDropEnd:function(){}};return{restrict:"A",scope:{instance:"=calendry"},replace:!0,templateUrl:"/calendry",transclude:!0,link:s,controller:["$scope",function(e){var n=this;e.instance=t.extend(n,v,e.instance||{}),this.goToCurrentMonth=e.goToCurrentMonth=function(){e.instance.currentMonth=r()},this.goToPrevMonth=e.goToPrevMonth=function(){e.instance.currentMonth=r(e.instance.currentMonth).subtract({months:1})},this.goToNextMonth=e.goToNextMonth=function(){e.instance.currentMonth=r(e.instance.currentMonth).add({months:1})},this.toggleListView=e.toggleListView=function(){e.instance.forceListView=!e.instance.forceListView},e.$watch("instance.currentMonth",function(t){t&&(e.instance.monthMap=o(t),e.instance.onMonthChange.apply(n,[e.instance.monthMap]))}),e.$watch("instance.events",function(t){t&&(e.events=t)}),e.helpers={eventFontColor:function(e){var t=d(e),n=Math.round((299*t.r+587*t.g+114*t.b)/1e3);return n>125?"#000000":"#FFFFFF"}}}]}}])}(window,window.angular);